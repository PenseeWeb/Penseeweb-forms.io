<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PenseeWeb - Professional Mindmap Creation</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Adsterra Popunder Code -->
    <script type='text/javascript' src='//pl25301550.profitablecpmrate.com/89/7e/ce/897ece1951c038a06b458a8ced092a5c.js'></script>
    <style>
        /* Your existing CSS remains unchanged */
        [Previous CSS content remains exactly the same]
    </style>
</head>
<body>
    <!-- Your existing HTML content remains unchanged -->
    [Previous HTML content remains exactly the same]

    <script>
        const supabaseClient = supabase.createClient(
            'https://rgccooiyalkqiugaxzbk.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnY2Nvb2l5YWxrcWl1Z2F4emJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjk5NjIzNzgsImV4cCI6MjA0NTUzODM3OH0.JomIxLPTFnGoxDf7WXpg41Vb9M-RKeZJ4oowSstaWT0'
        );

        // Check for stored data on page load
        window.onload = function() {
            const formData = localStorage.getItem('penseewebFormData');
            if (!formData) {
                document.getElementById('errorMessage').textContent = 'Please start from the beginning of the process.';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('submitButton').disabled = true;
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
            }
        };

        // Function to trigger ad
        function triggerAd() {
            // This will trigger the Adsterra popunder
            const clickEvent = new MouseEvent('click', {
                view: window,
                bubbles: true,
                cancelable: true
            });
            document.body.dispatchEvent(clickEvent);
        }

        document.getElementById('mindmapForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const storedData = JSON.parse(localStorage.getItem('penseewebFormData'));
            
            if (!email) {
                document.getElementById('errorMessage').textContent = 'Please enter your email address';
                document.getElementById('errorMessage').style.display = 'block';
                return;
            }

            if (!storedData) {
                document.getElementById('errorMessage').textContent = 'No input data found. Please start from the beginning.';
                document.getElementById('errorMessage').style.display = 'block';
                return;
            }

            // Trigger ad before showing loading spinner
            triggerAd();

            // Show loading spinner and disable submit button
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('submitButton').disabled = true;
            document.getElementById('errorMessage').style.display = 'none';

            try {
                // Get user's IP address
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const userIP = ipData.ip;

                // Prepare data for Supabase
                const submissionData = {
                    email: email,
                    content: storedData.content,
                    input_type: storedData.input_type,
                    content_length: storedData.content_length,
                    processing_status: 'pending',
                    is_processed: false,
                    user_ip: userIP,
                    metadata: {
                        original_timestamp: storedData.timestamp,
                        submission_timestamp: new Date().toISOString()
                    }
                };

                // Submit to Supabase
                const { error } = await supabaseClient
                    .from('penseeweb_forms')
                    .insert([submissionData]);

                if (error) throw error;

                // Clear stored data and show success message
                localStorage.removeItem('penseewebFormData');
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('mindmapForm').reset();
                
                // Disable back button
                history.pushState(null, null, location.href);
                window.onpopstate = function() {
                    history.go(1);
                };

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('submitButton').disabled = false;
                document.getElementById('errorMessage').textContent = 'There was an error submitting your request. Please try again.';
                document.getElementById('errorMessage').style.display = 'block';
            }
        });
    </script>
</body>
</html>
