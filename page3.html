<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PenseeWeb - Professional Mindmap Creation</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Propeller Ads Integration -->
    <!-- Interstitial -->
    <script>(function(d,z,s){s.src='https://'+d+'/401/'+z;try{(document.body||document.documentElement).appendChild(s)}catch(e){}})('groleegni.net',8668780,document.createElement('script'));</script>
    
    <!-- Vignette -->
    <script>(function(d,z,s){s.src='https://'+d+'/401/'+z;try{(document.body||document.documentElement).appendChild(s)}catch(e){}})('cimtaiphos.com',8668776,document.createElement('script'));</script>
    
    <!-- Onclick -->
    <script>(function(s,u,z,p){s.src=u,s.setAttribute('data-zone',z),p.appendChild(s);})(document.createElement('script'),'https://shebudriftaiter.net/tag.min.js',8668772,document.body||document.documentElement)</script>

    <!-- Adsterra Integration -->
    <script async="async" data-cfasync="false" src="//pl25301828.profitablecpmrate.com/5a0a6d52f643547f356c1aeafcfac4f7/invoke.js"></script>

    <style>
        :root {
            --primary-color: #faeae6;
            --accent-color: #d4756d;
            --text-color: #2c1810;
            --shadow-color: rgba(0,0,0,0.1);
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Playfair Display', serif;
            background-color: var(--primary-color);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, rgba(250,234,230,0.8) 0%, rgba(212,117,109,0.1) 100%);
            z-index: -1;
        }
        .container {
            max-width: 500px;
            width: 100%;
            padding: 40px;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px var(--shadow-color);
            backdrop-filter: blur(10px);
            transform: translateZ(0);
            transition: 0.3s ease;
        }
        .container:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px var(--shadow-color);
        }

        /* TV Frame and Ad Container Styles */
        .ad-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(250, 234, 230, 0.95);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .ad-container {
            position: relative;
            max-width: 600px;
            width: 90%;
            background: var(--primary-color);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(212,117,109,0.3);
            animation: slideIn 0.5s ease-out;
        }

        .tv-frame {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 15px;
            border: 8px solid #2a2a2a;
            box-shadow: 0 0 30px rgba(0,0,0,0.5),
                        inset 0 0 10px rgba(0,0,0,0.8);
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            overflow: hidden;
            background: linear-gradient(145deg, #232323 0%, #0a0a0a 100%);
        }

        .tv-brand-logo {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #d4756d 0%, #c26259 100%);
            padding: 5px 15px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 2;
        }

        .tv-brand-logo span {
            font-family: 'Playfair Display', serif;
            color: white;
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 2px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        .tv-screen {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 16/9;
            border: 2px solid #444;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }

        .tv-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(212,117,109,0.1) 0%, transparent 100%);
            pointer-events: none;
            z-index: 1;
        }

        .ad-space {
            position: relative;
            width: 100%;
            height: 100%;
            background: #000;
        }

        .ad-slot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .ad-slot.ad-active {
            display: block;
            opacity: 1;
            pointer-events: auto;
        }

        .ad-controls {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 3;
        }

        .timer {
            background: rgba(212, 117, 109, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-family: 'Poppins', sans-serif;
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .close-button {
            display: none;
            background: rgba(255, 255, 255, 0.9);
            color: var(--accent-color);
            border: none;
            padding: 5px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: 0.3s ease;
        }

        .close-button:hover {
            background: white;
            transform: translateY(-2px);
        }

        .disclaimer {
            position: absolute;
            bottom: -40px;
            left: 0;
            right: 0;
            text-align: center;
            font-family: 'Playfair Display', serif;
            font-style: italic;
            color: #2c1810;
            font-size: 0.8em;
            line-height: 1.4;
            padding: 10px;
            background: rgba(250, 234, 230, 0.9);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            .ad-container {
                width: 95%;
                padding: 15px;
            }
            .disclaimer {
                font-size: 0.7em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PenseeWeb</h1>
            <p>Create Your Professional Mindmap</p>
        </div>
        <form id="mindmapForm">
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" required placeholder="Enter your email to receive the mindmap">
            </div>
            <button type="submit" id="submitButton">Complete Submission</button>
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage" style="display: none;">
                Submission Complete! üéâ<br>
                Your mindmap will be sent to your email within 24 hours.<br>
                Don't forget to check your spam folder!<br>‚ú®
            </div>
            <div class="note">
                Note: Due to our limited V2 system capacity, mindmap generation might take up to 24 hours. 
                We sincerely apologize for any delay or inconvenience. üôè
            </div>
        </form>
    </div>

    <div class="ad-overlay" id="adOverlay">
        <div class="ad-container">
            <div class="ad-header">
                "Dear visitor, we apologize for the brief interruption. As we strive to maintain and improve our services, 
                we rely on ad support. Your request has already been queued, and your mindmap will be delivered within 24 hours. 
                Thank you for your patience and understanding. ‚ú®"
            </div>
            <div class="tv-frame">
                <div class="tv-brand-logo">
                    <span>PenseeWeb Premium</span>
                </div>
                <div class="tv-screen">
                    <div class="ad-space">
                        <!-- Propeller Ads Slots -->
                        <div class="ad-slot propeller-slot" id="propSlot1">
                            <!-- Interstitial -->
                            <div id="propeller-interstitial"></div>
                        </div>
                        <div class="ad-slot propeller-slot" id="propSlot2">
                            <!-- Vignette -->
                            <div id="propeller-vignette"></div>
                        </div>
                        <div class="ad-slot propeller-slot" id="propSlot3">
                            <!-- Onclick -->
                            <div id="propeller-onclick"></div>
                        </div>

                        <!-- Adsterra Slots -->
                        <div class="ad-slot" id="adSlot1">
                            <script async="async" data-cfasync="false" src="//pl25301828.profitablecpmrate.com/5a0a6d52f643547f356c1aeafcfac4f7/invoke.js"></script>
                            <div id="container-5a0a6d52f643547f356c1aeafcfac4f7"></div>
                        </div>
                        <div class="ad-slot" id="adSlot2">
                            <script async="async" data-cfasync="false" src="//pl25301828.profitablecpmrate.com/5a0a6d52f643547f356c1aeafcfac4f7/invoke.js"></script>
                            <div id="container-5a0a6d52f643547f356c1aeafcfac4f7-2"></div>
                        </div>
                        <div class="ad-slot" id="adSlot3">
                            <script async="async" data-cfasync="false" src="//pl25301828.profitablecpmrate.com/5a0a6d52f643547f356c1aeafcfac4f7/invoke.js"></script>
                            <div id="container-5a0a6d52f643547f356c1aeafcfac4f7-3"></div>
                        </div>
                        <div class="ad-slot" id="adSlot4">
                            <script async="async" data-cfasync="false" src="//pl25301828.profitablecpmrate.com/5a0a6d52f643547f356c1aeafcfac4f7/invoke.js"></script>
                            <div id="container-5a0a6d52f643547f356c1aeafcfac4f7-4"></div>
                        </div>
                        <div class="ad-slot" id="adSlot5">
                            <script async="async" data-cfasync="false" src="//pl25301828.profitablecpmrate.com/5a0a6d52f643547f356c1aeafcfac4f7/invoke.js"></script>
                            <div id="container-5a0a6d52f643547f356c1aeafcfac4f7-5"></div>
                        </div>
                    </div>
                    <div class="tv-brand">PenseeWeb</div>
                </div>
                <div class="ad-controls">
                    <div class="timer" id="adTimer">14</div>
                    <button class="close-button" id="closeButton" style="display: none;">Close TV</button>
                </div>
                <div class="disclaimer">
                    "Disclaimer: The advertisements displayed are from third-party networks. 
                    PenseeWeb does not endorse, guarantee, or take responsibility for any products, 
                    services, or actions resulting from these advertisements. Interaction with 
                    these ads is solely at your own discretion and risk. We maintain our 
                    commitment to providing you with our core services while remaining 
                    independent of advertised content." 
                    ‚Äî PenseeWeb Management
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Client Initialization
        const supabaseClient = supabase.createClient(
            'https://rgccooiyalkqiugaxzbk.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnY2Nvb2l5YWxrcWl1Z2F4emJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjk5NjIzNzgsImV4cCI6MjA0NTUzODM3OH0.JomIxLPTFnGoxDf7WXpg41Vb9M-RKeZJ4oowSstaWT0'
        );

        // Ad System Configuration
        const adConfig = {
            propellerIds: {
                interstitial: '8668780',
                vignette: '8668776',
                onclick: '8668772'
            },
            adsterraCodes: {
                native: '5a0a6d52f643547f356c1aeafcfac4f7'
            }
        };

        // Advanced Ad System Implementation
        const adSystem = {
            async showAds() {
                const overlay = document.getElementById('adOverlay');
                const timer = document.getElementById('adTimer');
                const closeButton = document.getElementById('closeButton');
                const propellerSlots = [
                    document.getElementById('propSlot1'),
                    document.getElementById('propSlot2'),
                    document.getElementById('propSlot3')
                ];
                const adsterraSlots = [
                    document.getElementById('adSlot1'),
                    document.getElementById('adSlot2'),
                    document.getElementById('adSlot3'),
                    document.getElementById('adSlot4'),
                    document.getElementById('adSlot5')
                ];
                
                overlay.style.display = 'flex';
                
                let totalTime = 14;
                let currentAdIndex = 0;
                let clickCount = 0;
                let isVideoAd = false;
                let adRotationInterval;
                
                // Initialize first Propeller ad
                propellerSlots[0].classList.add('ad-active');

                // Track ad clicks with double-click protection
                [...propellerSlots, ...adsterraSlots].forEach(slot => {
                    slot.addEventListener('click', (e) => {
                        clickCount++;
                        if (clickCount < 2) {
                            e.preventDefault();
                            e.stopPropagation();
                        }
                    });
                });

                return new Promise(resolve => {
                    const countdown = setInterval(() => {
                        timer.textContent = Math.max(0, totalTime);
                        totalTime--;

                        // First 14 seconds: alternate between networks
                        if (totalTime >= 0) {
                            if (!isVideoAd) {
                                const currentTime = 14 - totalTime;
                                if (currentTime % 3.5 === 0) {
                                    const allSlots = [...propellerSlots, ...adsterraSlots];
                                    allSlots.forEach(slot => slot.classList.remove('ad-active'));
                                    
                                    // Alternate between networks
                                    if (currentTime % 7 === 0) {
                                        propellerSlots[currentAdIndex % propellerSlots.length].classList.add('ad-active');
                                    } else {
                                        adsterraSlots[currentAdIndex % adsterraSlots.length].classList.add('ad-active');
                                    }
                                    currentAdIndex++;
                                }
                            }
                        }

                        // After 14 seconds
                        if (totalTime === 0) {
                            closeButton.style.display = 'block';
                            
                            // Start extended rotation
                            clearInterval(countdown);
                            
                            adRotationInterval = setInterval(() => {
                                const allSlots = [...propellerSlots, ...adsterraSlots];
                                allSlots.forEach(slot => slot.classList.remove('ad-active'));
                                
                                // Alternate between Propeller (25s) and Adsterra (until closed)
                                if (currentAdIndex % 2 === 0) {
                                    propellerSlots[currentAdIndex % propellerSlots.length].classList.add('ad-active');
                                    setTimeout(() => {
                                        if (!isVideoAd) {
                                            propellerSlots[currentAdIndex % propellerSlots.length].classList.remove('ad-active');
                                            adsterraSlots[currentAdIndex % adsterraSlots.length].classList.add('ad-active');
                                        }
                                    }, 25000);
                                }
                                
                                currentAdIndex++;
                            }, 30000);
                        }
                    }, 1000);

                    closeButton.onclick = () => {
                        clearInterval(countdown);
                        clearInterval(adRotationInterval);
                        overlay.style.display = 'none';
                        [...propellerSlots, ...adsterraSlots].forEach(slot => 
                            slot.classList.remove('ad-active'));
                        resolve();
                    };
                });
            }
        };

        // Form Submission Handler
        document.getElementById('mindmapForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const storedData = JSON.parse(localStorage.getItem('penseewebFormData'));
            
            if (!email) {
                document.getElementById('errorMessage').textContent = 'Please enter your email address';
                document.getElementById('errorMessage').style.display = 'block';
                return;
            }

            if (!storedData) {
                document.getElementById('errorMessage').textContent = 'No input data found. Please start from the beginning.';
                document.getElementById('errorMessage').style.display = 'block';
                return;
            }

            try {
                // Show ads first
                await adSystem.showAds();

                // Get user IP
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const userIP = ipData.ip;

                // Prepare submission data
                const submissionData = {
                    email: email,
                    content: storedData.content,
                    input_type: storedData.input_type,
                    content_length: storedData.content_length,
                    processing_status: 'pending',
                    is_processed: false,
                    user_ip: userIP,
                    metadata: {
                        original_timestamp: storedData.timestamp,
                        submission_timestamp: new Date().toISOString()
                    }
                };

                // Submit to Supabase
                const { error } = await supabaseClient
                    .from('penseeweb_forms')
                    .insert([submissionData]);

                if (error) throw error;

                // Clear storage and show success
                localStorage.removeItem('penseewebFormData');
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('mindmapForm').reset();
                
                // Prevent back navigation
                history.pushState(null, null, location.href);
                window.onpopstate = function() {
                    history.go(1);
                };

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('submitButton').disabled = false;
                document.getElementById('errorMessage').textContent = 'There was an error submitting your request. Please try again.';
                document.getElementById('errorMessage').style.display = 'block';
            }
        });

        // Initial page load check
        window.onload = function() {
            const formData = localStorage.getItem('penseewebFormData');
            if (!formData) {
                document.getElementById('errorMessage').textContent = 'Please start from the beginning of the process.';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('submitButton').disabled = true;
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
            }
        };
    </script>
</body>
</html>
