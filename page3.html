<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PenseeWeb - Professional Mindmap Creation</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #faeae6;
            --accent-color: #d4756d;
            --text-color: #2c1810;
            --shadow-color: rgba(0,0,0,0.1);
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Playfair Display', serif;
            background-color: var(--primary-color);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, rgba(250,234,230,0.8) 0%, rgba(212,117,109,0.1) 100%);
            z-index: -1;
        }
        .container {
            max-width: 500px;
            width: 100%;
            padding: 40px;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px var(--shadow-color);
            backdrop-filter: blur(10px);
            transform: translateZ(0);
            transition: 0.3s ease;
        }
        .container:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px var(--shadow-color);
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .header h1 {
            font-size: 3.5em;
            color: var(--accent-color);
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .header p {
            font-size: 1.2em;
            color: var(--text-color);
            opacity: 0.8;
        }
        .form-group {
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 1.1em;
            color: var(--text-color);
            font-weight: 500;
        }
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(212,117,109,0.2);
            border-radius: 12px;
            font-size: 1em;
            transition: 0.3s ease;
            background: rgba(255,255,255,0.9);
        }
        input:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 15px rgba(212,117,109,0.2);
        }
        button {
            background: linear-gradient(135deg, var(--accent-color) 0%, #c26259 100%);
            color: #fff;
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            cursor: pointer;
            transition: 0.3s ease;
            width: 100%;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212,117,109,0.4);
        }

        .ad-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(44, 24, 16, 0.95);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .ad-container {
            position: relative;
            max-width: 800px;
            width: 90%;
            background: var(--primary-color);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(212,117,109,0.3);
            animation: slideIn 0.5s ease-out;
        }

        .ad-header {
            text-align: center;
            margin-bottom: 20px;
            color: var(--accent-color);
            font-style: italic;
            font-family: 'Playfair Display', serif;
            line-height: 1.6;
            padding: 0 20px;
        }

        .tv-frame {
            background: #1a1a1a;
            padding: 35px;
            border-radius: 30px;
            border: 12px solid #2a2a2a;
            box-shadow: 0 0 50px rgba(0,0,0,0.5),
                        inset 0 0 20px rgba(0,0,0,0.8);
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            overflow: visible;
            background: linear-gradient(145deg, #232323 0%, #0a0a0a 100%);
        }

        .tv-frame::before {
            content: '';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 25px;
            background: linear-gradient(180deg, #444 0%, #333 100%);
            border-radius: 10px 10px 0 0;
            box-shadow: 0 -5px 10px rgba(0,0,0,0.3);
        }

        .tv-antenna {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 40px;
            background: #555;
            z-index: 1;
        }

        .tv-antenna::before,
        .tv-antenna::after {
            content: '';
            position: absolute;
            top: 0;
            width: 30px;
            height: 2px;
            background: #555;
        }

        .tv-antenna::before {
            transform: rotate(45deg);
            left: -13px;
        }

        .tv-antenna::after {
            transform: rotate(-45deg);
            right: -13px;
        }

        .tv-screen {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            aspect-ratio: 16/9;
            border: 3px solid #444;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.8);
        }

        .tv-static {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255,255,255,0.1) 50%, transparent 50%);
            background-size: 100% 4px;
            pointer-events: none;
            opacity: 0.1;
            z-index: 2;
            animation: tvStatic 0.1s infinite;
        }

        .tv-glow {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-shadow: inset 0 0 100px rgba(255,255,255,0.1);
            pointer-events: none;
            z-index: 3;
        }

        .tv-reflection {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, transparent 100%);
            pointer-events: none;
            z-index: 4;
        }

        .tv-controls {
            position: absolute;
            bottom: -20px;
            right: 40px;
            display: flex;
            gap: 15px;
        }

        .tv-knob {
            width: 25px;
            height: 25px;
            background: linear-gradient(145deg, #444 0%, #333 100%);
            border-radius: 50%;
            border: 2px solid #222;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .tv-speakers {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }

        .speaker {
            width: 60px;
            height: 120px;
            background: linear-gradient(90deg, #2a2a2a 0%, #222 100%);
            border-radius: 5px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            padding: 5px;
        }

        .speaker-hole {
            width: 100%;
            height: 8px;
            background: #181818;
            border-radius: 4px;
        }

        .ad-space {
            position: relative;
            width: 100%;
            height: 100%;
            background: #000;
        }

        .primary-ad, .secondary-ad {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.98);
            width: 100%;
            height: 100%;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .ad-active {
            display: block;
            opacity: 1;
        }

        @keyframes tvStatic {
            0% { transform: translateY(0); }
            100% { transform: translateY(4px); }
        }

        .tv-brand {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            color: #666;
            font-family: 'Arial', sans-serif;
            font-size: 14px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .error-message, .success-message {
            display: none;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: center;
        }

        .error-message {
            background: rgba(255,0,0,0.1);
            color: #d32f2f;
        }

        .success-message {
            background: rgba(76,175,80,0.1);
            color: #388e3c;
        }

        .note {
            margin-top: 20px;
            text-align: center;
            font-size: 0.9em;
            color: var(--text-color);
            opacity: 0.7;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            .header h1 {
                font-size: 2.5em;
            }
            .ad-container {
                width: 95%;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PenseeWeb</h1>
            <p>Create Your Professional Mindmap</p>
        </div>
        <form id="mindmapForm">
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" required placeholder="Enter your email to receive the mindmap">
            </div>
            <button type="submit" id="submitButton">Complete Submission</button>
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage">
                Submission Complete! 🎉<br>
                Your mindmap will be sent to your email within 24 hours.<br>
                Don't forget to check your spam folder!<br>✨
            </div>
            <div class="note">
                Note: Due to our limited V2 system capacity, mindmap generation might take up to 24 hours. 
                We sincerely apologize for any delay or inconvenience. 🙏
            </div>
        </form>
    </div>

    <div class="ad-overlay" id="adOverlay">
        <div class="ad-container">
            <div class="ad-header">
                "Dear visitor, we apologize for the brief interruption. As we strive to maintain and improve our services, 
                we rely on ad support. Your request has already been queued, and your mindmap will be delivered within 24 hours. 
                Thank you for your patience and understanding. ✨"
            </div>
            <div class="tv-frame">
                <div class="tv-antenna"></div>
                <div class="tv-screen">
                    <div class="tv-static"></div>
                    <div class="tv-glow"></div>
                    <div class="tv-reflection"></div>
                    <div class="ad-space">
                        <div class="primary-ad" id="primaryAd">
                            <!-- First Ad -->
                            <script async="async" data-cfasync="false" src="//pl25301828.profitablecpmrate.com/5a0a6d52f643547f356c1aeafcfac4f7/invoke.js"></script>
                            <div id="container-5a0a6d52f643547f356c1aeafcfac4f7"></div>
                        </div>
                        <div class="secondary-ad" id="secondaryAd">
                            <!-- Second Ad -->
                            <script async="async" data-cfasync="false" src="//pl25301828.profitablecpmrate.com/5a0a6d52f643547f356c1aeafcfac4f7/invoke.js"></script>
                            <div id="container-5a0a6d52f643547f356c1aeafcfac4f7-2"></div>
                        </div>
                    </div>
                </div>
                <div class="tv-controls">
                    <div class="tv-knob"></div>
                    <div class="tv-knob"></div>
                    <div class="tv-knob"></div>
                </div>
                <div class="tv-speakers">
                    <div class="speaker">
                        <div class="speaker-hole"></div>
                        <div class="speaker-hole"></div>
                        <div class="speaker-hole"></div>
                        <div class="speaker-hole"></div>
                    </div>
                </div>
                <div class="tv-brand">PenseeTV</div>
                <div class="ad-controls">
                    <div class="timer" id="adTimer">14</div>
                    <button class="close-button" id="closeButton" style="display: none;">Close TV</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const supabaseClient = supabase.createClient(
            'https://rgccooiyalkqiugaxzbk.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJnY2Nvb2l5YWxrcWl1Z2F4emJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjk5NjIzNzgsImV4cCI6MjA0NTUzODM3OH0.JomIxLPTFnGoxDf7WXpg41Vb9M-RKeZJ4oowSstaWT0'
        );

        const adSystem = {
            async showAds() {
                const overlay = document.getElementById('adOverlay');
                const timer = document.getElementById('adTimer');
                const closeButton = document.getElementById('closeButton');
                const primaryAd = document.getElementById('primaryAd');
                const secondaryAd = document.getElementById('secondaryAd');
                
                overlay.style.display = 'flex';
                
                // Initialize ads
                primaryAd.style.display = 'none';
                secondaryAd.style.display = 'none';
                
                let totalTime = 14;
                
                return new Promise(resolve => {
                    // Show first ad
                    primaryAd.style.display = 'block';
                    setTimeout(() => primaryAd.classList.add('ad-active'), 100);
                    
                    const countdown = setInterval(() => {
                        timer.textContent = totalTime;
                        totalTime--;
                        
                        // Switch to second ad after 7 seconds
                        if (totalTime === 6) {
                            // Fade out first ad
                            primaryAd.classList.remove('ad-active');
                            setTimeout(() => {
                                primaryAd.style.display = 'none';
                                // Show second ad
                                secondaryAd.style.display = 'block';
                                setTimeout(() => secondaryAd.classList.add('ad-active'), 100);
                            }, 500);
                        }
                        
                        // Show close button when timer ends
                        if (totalTime < 0) {
                            clearInterval(countdown);
                            closeButton.style.display = 'block';
                            timer.textContent = '0';
                        }
                    }, 1000);

                    closeButton.onclick = () => {
                        overlay.style.display = 'none';
                        primaryAd.style.display = 'none';
                        secondaryAd.style.display = 'none';
                        resolve();
                    };
                });
            }
        };

        document.getElementById('mindmapForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const storedData = JSON.parse(localStorage.getItem('penseewebFormData'));
            
            if (!email) {
                document.getElementById('errorMessage').textContent = 'Please enter your email address';
                document.getElementById('errorMessage').style.display = 'block';
                return;
            }

            if (!storedData) {
                document.getElementById('errorMessage').textContent = 'No input data found. Please start from the beginning.';
                document.getElementById('errorMessage').style.display = 'block';
                return;
            }

            // Show ads first
            await adSystem.showAds();

            try {
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const userIP = ipData.ip;

                const submissionData = {
                    email: email,
                    content: storedData.content,
                    input_type: storedData.input_type,
                    content_length: storedData.content_length,
                    processing_status: 'pending',
                    is_processed: false,
                    user_ip: userIP,
                    metadata: {
                        original_timestamp: storedData.timestamp,
                        submission_timestamp: new Date().toISOString()
                    }
                };

                const { error } = await supabaseClient
                    .from('penseeweb_forms')
                    .insert([submissionData]);

                if (error) throw error;

                localStorage.removeItem('penseewebFormData');
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('mindmapForm').reset();
                
                history.pushState(null, null, location.href);
                window.onpopstate = function() {
                    history.go(1);
                };

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('submitButton').disabled = false;
                document.getElementById('errorMessage').textContent = 'There was an error submitting your request. Please try again.';
                document.getElementById('errorMessage').style.display = 'block';
            }
        });

        window.onload = function() {
            const formData = localStorage.getItem('penseewebFormData');
            if (!formData) {
                document.getElementById('errorMessage').textContent = 'Please start from the beginning of the process.';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('submitButton').disabled = true;
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
            }
        };
    </script>
</body>
</html>
